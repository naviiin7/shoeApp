<div class="max-w-7xl mx-auto px-6 py-10">

  <!-- Loading -->
  <div *ngIf="loading" class="text-center text-gray-400 py-14 text-lg">
    Loading product…
  </div>

  <!-- Product via async pipe -->
  <ng-container *ngIf="product$ | async as p">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">

      <!-- LEFT — IMAGE -->
      <div class="flex flex-col gap-6">
        <div class="hero-image-wrap glass-card p-4 rounded-2xl flex items-center justify-center">
          <img
            [src]="activeImage || p.image || defaultImage"
            (error)="onImgError($event)"
            alt="{{ p.name }}"
            class="product-main-img w-full max-h-[520px] object-contain"
          />
        </div>
      </div>

      <!-- RIGHT — DETAILS -->
      <div class="glass-card p-6 rounded-2xl">
        <div class="flex items-start justify-between gap-6">
          <div>
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-100 mb-2 tracking-tight">
              {{ p.name }}
            </h1>
            <div class="text-sm text-gray-300 mb-2">{{ p.brand }} · {{ p.category }}</div>
          </div>

          <div class="text-2xl md:text-3xl font-extrabold text-accent">
            ${{ p.price | number:'1.2-2' }}
          </div>
        </div>

        <p class="text-gray-300 text-base leading-relaxed mt-4 mb-6">
          {{ p.description || 'This product currently has no description.' }}
        </p>

        <!-- Sizes -->
        <div *ngIf="p.sizes?.length" class="mb-6">
          <h3 class="font-semibold text-gray-200 mb-3">Select Size</h3>

          <div class="flex flex-wrap gap-3">
            <button
              *ngFor="let s of p.sizes"
              (click)="selectSize(s)"
              [ngClass]="selectedSize === s ? 'selected-size' : 'unselected-size'"
              class="px-4 py-2 rounded-lg text-sm transition"
              type="button"
            >
              {{ s }}
            </button>
          </div>

          <div *ngIf="sizeError" class="text-rose-500 text-sm mt-2">
            Please select a size.
          </div>
        </div>

        <!-- Quantity -->
        <div class="mb-6">
          <h3 class="font-semibold text-gray-200 mb-2">Quantity</h3>
          <div class="flex items-center gap-3">
            <button class="px-3 py-1 border rounded hover:bg-gray-800 text-gray-200"
              (click)="qty = qty > 1 ? qty - 1 : 1" type="button">−</button>

            <span class="text-lg font-semibold text-gray-100">{{ qty }}</span>

            <button class="px-3 py-1 border rounded hover:bg-gray-800 text-gray-200"
              (click)="qty = qty + 1" type="button">+</button>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex gap-4 mt-4">
          <button
            (click)="addToCart()"
            class="btn-accent px-6 py-3 rounded-lg shadow-lg hover:brightness-105 transition active:scale-[0.98]"
            type="button"
          >
            Add to Cart
          </button>

          <button
            (click)="buyNow()"
            class="btn-ghost px-6 py-3 rounded-lg border hover:bg-gray-800 transition active:scale-[0.98]"
            type="button"
          >
            Buy Now
          </button>
        </div>

        <!-- Meta row -->
        <div class="mt-5 text-sm text-gray-400">
          <div>Availability: <span class="font-medium text-gray-100">{{ p.inStock ? 'In Stock' : 'Out of Stock' }}</span></div>
        </div>
      </div>
    </div>

    <!-- SIMILAR PRODUCTS (driven by RxJS) -->
    <section class="mt-12">
      <h3 class="text-xl font-bold text-gray-100 mb-4">Similar Products</h3>

      <ng-container *ngIf="similarProducts$ | async as similarProducts">
        <div *ngIf="similarProducts.length > 0" class="flex gap-4 overflow-x-auto pb-2">
          <div *ngFor="let s of similarProducts; trackBy: trackById" class="w-64 shrink-0">
            <div class="relative group rounded-xl overflow-hidden glass-card p-3 cursor-pointer" (click)="gotoSuggestion(s)" tabindex="0" role="button">
              <div class="w-full h-40 bg-gray-900 rounded-lg flex items-center justify-center overflow-hidden">
                <img [src]="s.image || defaultImage" [alt]="s.name" class="w-full h-full object-cover transition group-hover:scale-105"/>
              </div>
              <div class="mt-3">
                <div class="text-sm font-semibold text-gray-100 truncate">{{ s.name }}</div>
                <div class="text-xs text-gray-400">${{ s.price | number:'1.2-2' }}</div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="similarProducts.length === 0" class="text-gray-400">
          No similar products found.
        </div>
      </ng-container>
    </section>

  </ng-container>

</div>
